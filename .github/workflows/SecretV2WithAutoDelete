name: Auto-Delete Artifact After 5 Minutes

on:
  workflow_dispatch:

jobs:
  create-and-delete:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create secret file
      env:
        MY_SECRET: ${{ secrets.MY_SECRET }}
      run: |
        mkdir -p config
        echo "$MY_SECRET" > config/secret.txt
        chmod 600 config/secret.txt
        
    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: secret-file
        path: config/secret.txt
        retention-days: 1  # Still required but will be overridden
        
    - name: Get artifact ID
      id: get-artifact
      run: |
        ARTIFACT_ID=$(gh api repos/$GITHUB_REPOSITORY/actions/artifacts \
          --jq '.artifacts[] | select(.name == "secret-file") | .id')
        echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ github.token }}
        
    - name: Delete after 5 minutes (async)
      run: |
        gh api -X DELETE repos/$GITHUB_REPOSITORY/actions/artifacts/${{ steps.get-artifact.outputs.artifact_id }} \
          || echo "Artifact already deleted" &
        sleep 120  # 2 minute delay
        kill $! 2>/dev/null || true
      env:
        GITHUB_TOKEN: ${{ github.token }}
